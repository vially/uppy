{"version":3,"sources":["../../../src/plugins/Transloadit/index.test.js"],"names":["Core","require","Transloadit","describe","it","uppy","expect","use","params","toThrowError","not","autoProceed","getAssemblyOptions","file","name","toBe","data","Buffer","alloc","size","byteLength","addFile","upload","then","Error","err","message","toMatch","auth","key","steps","fake_step","tl","getPlugin","files","i","client","createAssembly","opts","toEqual","reject","assemblies","assembly","data2","alwaysRunAssembly","rejects","source","Uint8Array","fileID","Object","keys","getState","getFile","progress","uploadStarted","template_id"],"mappings":"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","file":"index.test.js","sourcesContent":["const Core = require('../../core')\nconst Transloadit = require('./')\n\ndescribe('Transloadit', () => {\n  it('Throws errors if options are missing', () => {\n    const uppy = new Core()\n\n    expect(() => {\n      uppy.use(Transloadit, { params: {} })\n    }).toThrowError(/The `params\\.auth\\.key` option is required/)\n  })\n\n  it('Accepts a JSON string as `params` for signature authentication', () => {\n    const uppy = new Core()\n\n    expect(() => {\n      uppy.use(Transloadit, {\n        params: 'not json'\n      })\n    }).toThrowError(/The `params` option is a malformed JSON string/)\n\n    expect(() => {\n      uppy.use(Transloadit, {\n        params: '{\"template_id\":\"some template id string\"}'\n      })\n    }).toThrowError(/The `params\\.auth\\.key` option is required/)\n    expect(() => {\n      uppy.use(Transloadit, {\n        params: '{\"auth\":{\"key\":\"some auth key string\"},\"template_id\":\"some template id string\"}'\n      })\n    }).not.toThrowError(/The `params\\.auth\\.key` option is required/)\n  })\n\n  it('Validates response from getAssemblyOptions()', () => {\n    const uppy = new Core({ autoProceed: false })\n\n    uppy.use(Transloadit, {\n      getAssemblyOptions: (file) => {\n        expect(file.name).toBe('testfile')\n        return {\n          params: '{\"some\":\"json\"}'\n        }\n      }\n    })\n\n    const data = Buffer.alloc(4000)\n    data.size = data.byteLength\n    uppy.addFile({\n      name: 'testfile',\n      data\n    })\n    return uppy.upload().then(() => {\n      throw new Error('should have rejected')\n    }, (err) => {\n      expect(err.message).toMatch(/The `params\\.auth\\.key` option is required/)\n    })\n  })\n\n  it('Uses different assemblies for different params', () => {\n    const uppy = new Core({ autoProceed: false })\n\n    uppy.use(Transloadit, {\n      getAssemblyOptions: (file) => ({\n        params: {\n          auth: { key: 'fake key' },\n          steps: {\n            fake_step: { data: file.name }\n          }\n        }\n      })\n    })\n\n    const tl = uppy.getPlugin('Transloadit')\n    const files = ['a.png', 'b.png', 'c.png', 'd.png']\n    let i = 0\n    tl.client.createAssembly = (opts) => {\n      expect(opts.params.steps.fake_step.data).toEqual(files[i])\n      i++\n      // Short-circuit upload\n      return Promise.reject('short-circuit') // eslint-disable-line prefer-promise-reject-errors\n    }\n\n    const data = Buffer.alloc(10)\n    data.size = data.byteLength\n\n    uppy.addFile({ name: 'a.png', data })\n    uppy.addFile({ name: 'b.png', data })\n    uppy.addFile({ name: 'c.png', data })\n    uppy.addFile({ name: 'd.png', data })\n\n    return uppy.upload().then(() => {\n      throw new Error('upload should have been rejected')\n    }, () => {\n      expect(i).toBe(4)\n    })\n  })\n\n  it('Should merge files with same parameters into one Assembly', () => {\n    const uppy = new Core({ autoProceed: false })\n\n    uppy.use(Transloadit, {\n      getAssemblyOptions: (file) => ({\n        params: {\n          auth: { key: 'fake key' },\n          steps: {\n            fake_step: { data: file.size }\n          }\n        }\n      })\n    })\n\n    const tl = uppy.getPlugin('Transloadit')\n    const assemblies = [\n      { data: 10, files: ['a.png', 'b.png', 'c.png'] },\n      { data: 20, files: ['d.png'] }\n    ]\n    let i = 0\n    tl.client.createAssembly = (opts) => {\n      const assembly = assemblies[i]\n      expect(opts.params.steps.fake_step.data).toBe(assembly.data)\n      i++\n      // Short-circuit upload\n      return Promise.reject('short-circuit') // eslint-disable-line prefer-promise-reject-errors\n    }\n\n    const data = Buffer.alloc(10)\n    data.size = data.byteLength\n    const data2 = Buffer.alloc(20)\n    data2.size = data2.byteLength\n\n    uppy.addFile({ name: 'a.png', data })\n    uppy.addFile({ name: 'b.png', data })\n    uppy.addFile({ name: 'c.png', data })\n    uppy.addFile({ name: 'd.png', data: data2 })\n\n    return uppy.upload().then(() => {\n      throw new Error('Upload should have been rejected')\n    }, () => {\n      expect(i).toBe(2)\n    })\n  })\n\n  it('Does not create an Assembly if no files are being uploaded', () => {\n    const uppy = new Core()\n    uppy.use(Transloadit, {\n      getAssemblyOptions () {\n        throw new Error('should not create Assembly')\n      }\n    })\n\n    return uppy.upload()\n  })\n\n  it('Creates an Assembly if no files are being uploaded but `alwaysRunAssembly` is enabled', () => {\n    const uppy = new Core()\n    uppy.use(Transloadit, {\n      alwaysRunAssembly: true,\n      getAssemblyOptions (file) {\n        // should call getAssemblyOptions with `null`\n        expect(file).toBe(null)\n        return Promise.reject('short-circuited') // eslint-disable-line prefer-promise-reject-errors\n      }\n    })\n\n    return expect(uppy.upload()).rejects.toEqual(new Error('short-circuited'))\n  })\n\n  it('Does not leave lingering progress if getAssemblyOptions fails', () => {\n    const uppy = new Core()\n    uppy.use(Transloadit, {\n      getAssemblyOptions (file) {\n        return Promise.reject(new Error('Failure!'))\n      }\n    })\n\n    uppy.addFile({\n      source: 'jest',\n      name: 'abc',\n      data: new Uint8Array(100)\n    })\n\n    return uppy.upload().then(() => {\n      throw new Error('Should not have succeeded')\n    }, (err) => {\n      const fileID = Object.keys(uppy.getState().files)[0]\n\n      expect(err.message).toBe('Failure!')\n      expect(uppy.getFile(fileID).progress.uploadStarted).toBe(false)\n    })\n  })\n\n  it('Does not leave lingering progress if creating assembly fails', () => {\n    const uppy = new Core()\n    uppy.use(Transloadit, {\n      params: {\n        auth: { key: 'some auth key string' },\n        template_id: 'some template id string'\n      }\n    })\n\n    uppy.getPlugin('Transloadit').client.createAssembly = () =>\n      Promise.reject(new Error('Could not create assembly!'))\n\n    uppy.addFile({\n      source: 'jest',\n      name: 'abc',\n      data: new Uint8Array(100)\n    })\n\n    return uppy.upload().then(() => {\n      throw new Error('Should not have succeeded')\n    }, (err) => {\n      const fileID = Object.keys(uppy.getState().files)[0]\n\n      expect(err.message).toBe('Could not create assembly!')\n      expect(uppy.getFile(fileID).progress.uploadStarted).toBe(false)\n    })\n  })\n})\n"]}